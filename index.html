<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto-Transitioning Slideshow For Holiday Bizarre</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

/* =============== GLOBAL VARIABLES ================= */
:root {
    --trans-speed: 1s;
    --fit: contain;
    --dash-mode: floating; /* floating | side | dock | editor */
}

/* =============== GLOBAL RESET ==================== */
body {
    margin: 0;
    overflow: hidden;
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
}

/* =============== SLIDESHOW ======================== */
#slideshow {
    position: fixed;
    inset: 0;
    overflow: hidden;
}
.slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity var(--trans-speed) ease-in-out;
}
.slide.active { opacity: 1; }

.slide img, .slide iframe, .slide video {
    width: 100%;
    height: 100%;
    object-fit: var(--fit);
    border: none;
}

/* ======== TRANSITION CLASSES (Phase 2 Core Set) ======== */

/* FADE */
.fade-in { animation: fadeIn var(--trans-speed) ease; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* SLIDE LEFT */
.slide-left { animation: slideLeft var(--trans-speed) ease; }
@keyframes slideLeft { from{transform:translateX(100%);} to{transform:translateX(0);} }

/* SLIDE RIGHT */
.slide-right { animation: slideRight var(--trans-speed) ease; }
@keyframes slideRight { from{transform:translateX(-100%);} to{transform:translateX(0);} }

/* ZOOM IN */
.zoom-in { animation: zoomIn var(--trans-speed) ease; }
@keyframes zoomIn { from{transform:scale(1.3);} to{transform:scale(1);} }

/* ZOOM OUT */
.zoom-out { animation: zoomOut var(--trans-speed) ease; }
@keyframes zoomOut { from{transform:scale(0.7);} to{transform:scale(1);} }

/* BLUR TRANSITION */
.blur-in { animation: blurIn var(--trans-speed) ease; }
@keyframes blurIn { from{filter:blur(20px);} to{filter:blur(0);} }

/* WIPE */
.wipe { animation: wipe var(--trans-speed) ease; overflow:hidden; }
@keyframes wipe { from{clip-path:inset(0 100% 0 0);} to{clip-path:inset(0 0 0 0);} }

/* GLITCH (lightweight) */
.glitch { animation: glitch 0.6s linear; }
@keyframes glitch {
    0%,100% { clip-path: inset(0 0 0 0); }
    20% { clip-path: inset(10% 0 30% 0); }
    40% { clip-path: inset(40% 0 20% 0); }
    60% { clip-path: inset(5% 0 60% 0); }
}

/* KEN BURNS */
.kenburns { animation: kenburns 12s ease-in-out forwards; }
@keyframes kenburns {
    from { transform: scale(1) translate(0,0); }
    to   { transform: scale(1.25) translate(-20px, -20px); }
}

/* 3D CUBE */
.cube { animation: cube var(--trans-speed) ease; transform-style: preserve-3d; }
@keyframes cube {
    from { transform: rotateY(90deg); }
    to   { transform: rotateY(0deg); }
}

/* 3D FLIP */
.flip { animation: flip var(--trans-speed) ease; transform-style: preserve-3d; }
@keyframes flip {
    from { transform: rotateY(-180deg); }
    to   { transform: rotateY(0deg); }
}

/* ============= CAPTION + DESCRIPTION PANEL ================= */
#caption-bar {
    position: fixed;
    bottom: 0;
    width: 100vw;
    background: rgba(0,0,0,0.4);
    padding: 10px;
    text-align: center;
    z-index: 100;
}
#description-panel {
    position: fixed;
    right: 0;
    top: 100px;
    width: 300px;
    height: 60vh;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    overflow-y: auto;
    display: none; /* Note: This is currently hidden */
    z-index: 100;
}

/* ============= DASHBOARD ========================== */
#dashboard {
    position: fixed;
    background: rgba(20,20,20,0.9);
    padding: 15px;
    color: white;
    border-radius: 10px;
    z-index: 9999;
    width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    box-sizing: border-box;
}

/* Floating Mode */
body[data-dash="floating"] #dashboard {
    left: 20px; top: 20px;
}

/* Side Panel Mode */
body[data-dash="side"] #dashboard {
    left: 0; top: 0; bottom: 0;
    width: 300px; border-radius: 0;
    max-height: 100vh;
}

/* Dock Mode */
body[data-dash="dock"] #dashboard {
    left: 0; right: 0; bottom: 0;
    width: 100%; height: 180px;
    border-radius: 0;
    max-height: 180px;
}

/* Editor Mode (full split view) */
body[data-dash="editor"] #dashboard {
    left: 0; top: 0; bottom: 0;
    width: 30vw; border-radius: 0;
    max-height: 100vh;
}

/* Add cursor to show the dashboard title is movable */
body[data-dash="floating"] #dashboard h2 {
    cursor: move;
}

/* ============= TIMELINE =========================== */
#timeline {
    position: fixed;
    bottom: 80px; /* Adjusted to be above caption-bar */
    width: 100%;
    height: 80px;
    background: rgba(0,0,0,0.7);
    overflow-x: auto;
    white-space: nowrap;
    z-index: 99;
}
.timeline-item {
    display: inline-block;
    width: 80px;
    height: 60px;
    margin: 10px;
    background: #333;
    border: 2px solid #444;
    cursor: grab;
}
.timeline-item.active { border-color: yellow; }
.timeline-item img { width: 100%; height: 100%; object-fit: cover; }

/* Styles for drag-and-drop timeline */
.timeline-item {
    cursor: grab; /* Shows items are draggable */
    position: relative; 
}
.timeline-item:active {
    cursor: grabbing;
}
/* A class to "hide" the original item while dragging */
.timeline-item.dragging {
    opacity: 0.4;
}

    /* Make timeline item relative for positioning the delete button */
.timeline-item {
    display: inline-block;
    width: 80px;
    height: 60px;
    margin: 10px;
    background: #333;
    border: 2px solid #444;
    cursor: grab;
    position: relative; /* ⭐️ ADDED THIS LINE */
}
.timeline-item.active { border-color: yellow; }
.timeline-item img { width: 100%; height: 100%; object-fit: cover; }

/* ⭐️ NEW: Add transition for fading controls */
#timeline, #caption-bar {
    transition: opacity 0.5s ease-in-out;
}

/* ⭐️ NEW: Hidden class to fade out controls */
#timeline.hidden, #caption-bar.hidden {
    opacity: 0;
    pointer-events: none; /* Prevents clicking on the invisible bar */
}
    
/* ⭐️ NEW: Style for the delete button on thumbnails */
.delete-slide-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(255, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    font-size: 14px;
    padding: 0;
}
.delete-slide-btn:hover {
    background: rgba(255, 0, 0, 1);
}
    
/* ============= FILTERS PANEL ====================== */
.filter-slider { width: 100%; }

/* ============= AUDIO PLAYER ======================== */
#audio-player {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 250px;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    z-index: 9998;
    border-radius: 8px;
}

/* ⭐️ NEW: Style for music upload buttons */
.music-btn {
    display: inline-block;
    background: #4a5568; /* A nice dark-bluish-gray */
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    margin: 2px;
    transition: background 0.2s;
}
.music-btn:hover {
    background: #2d3748;
}
    
/* ⭐️ NEW: Styles for the Stream-Here-Placeholder */
.stream-placeholder {
    width: 100%;
    height: 100%;
    background: #222;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
}
.stream-video {
    display: none; 
    width: 100%; 
    height: 100%;
    background: #000;
}
.stream-start-btn {
    font-size: 1.5em;
    font-weight: bold;
    color: white;
    background: #007bff;
    border: none;
    padding: 20px 30px;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s;
}
.stream-start-btn:hover {
    background: #0056b3;
}

/* ⭐️ NEW: Global Controls (Show/Fullscreen) */
#global-controls {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 10001;
    display: flex;
    gap: 10px;
}
#global-controls button {
    background: rgba(0,0,0,0.5);
    color: white;
    border: 1px solid #777;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
}
#global-controls button:hover {
    background: rgba(255,255,255,0.2);
}

/* ⭐️ NEW: Dashboard Close Button */
#close-panel-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    width: 30px;
    height: 30px;
    background: #555;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    z-index: 10;
}
#close-panel-btn:hover {
    background: #888;
}

</style>
</head>
<body data-dash="floating">
    
<!-- ⭐️ NEW: Add this block for global controls -->
<div id="global-controls">
    <button id="show-panel-btn">Show Controls</button>
    <button id="fullscreen-btn">Toggle Fullscreen</button>
</div>

<!-- (Your existing HTML <div id="slideshow">...</div> etc. goes here) -->
<div id="slideshow"></div>
<div id="caption-bar"></div>
<div id="description-panel"></div>
<div id="timeline"></div>

<!-- ⭐️ REPLACE your entire #audio-player div with this ⭐️ -->
<div id="audio-player">
    <strong>Music Playlist</strong><br>

    <!-- Audio element -->
    <audio id="bgm" controls style="width: 100%; margin-top: 5px;"></audio><br><br>

    <!-- Upload Buttons -->
    <label for="music-upload" class="music-btn">Add Music File(s)</label>
    <input type="file" id="music-upload" accept="audio/*" multiple style="display:none;">

    <label for="music-folder-upload" class="music-btn">Add Music Folder</label>
    <input type="file" id="music-folder-upload" webkitdirectory multiple style="display:none;">

    <label for="music-links-upload" class="music-btn">Add Links (.txt)</label>
    <input type="file" id="music-links-upload" accept=".txt,text/plain" style="display:none;">
    
    <br><br>

    <!-- Track list -->
    <div id="track-list" style="max-height:150px; overflow-y:auto; background: rgba(0,0,0,0.3); border-radius: 4px;"></div>
    <br>
    <button onclick="prevTrack()">Prev Track</button>
    <button onclick="nextTrack()">Next Track</button>
</div>

<div id="dashboard">
    <!-- ⭐️ NEW: Add this close button -->
    <button id="close-panel-btn">&times;</button>
    
    <h2>Control Dashboard</h2>
    <!-- (Rest of your dashboard content...) -->

<label><strong>Dashboard Layout</strong></label><br>
<select onchange="setDashboardMode(this.value)">
    <option value="floating">Floating</option>
    <option value="side">Side Panel</option>
    <option value="dock">Bottom Dock</option>
    <option value="editor">Editor Layout</option>
</select><br><br>

<hr>
<h3>Auto-Transition</h3>
<label>Delay (seconds)</label><br>
<input type="number" id="interval-duration" value="5" style="width: 60px;">
<br><br>
<button onclick="startSlideshow()">Start Auto-Play</button>
<button onclick="stopSlideshow()">Stop</button>
<hr>
<br>

<label><strong>Transition</strong></label><br>
<select id="transitionSelect">
    <option value="fade-in">Fade</option>
    <option value="slide-left">Slide Left</option>
    <option value="slide-right">Slide Right</option>
    <option value="zoom-in">Zoom In</option>
    <option value="zoom-out">Zoom Out</option>
    <option value="blur-in">Blur</option>
    <option value="wipe">Wipe</option>
    <option value="glitch">Glitch</option>
    <option value="kenburns">Ken Burns</option>
    <option value="cube">3D Cube</option>
    <option value="flip">3D Flip</option>
</select><br><br>

<h3>Filters</h3>
<label>Brightness</label><input type="range" min="50" max="150" value="100" class="filter-slider" id="bright"><br>
<label>Contrast</label><input type="range" min="50" max="200" value="100" class="filter-slider" id="contrast"><br>
<label>Saturation</label><input type="range" min="0" max="200" value="100" class="filter-slider" id="saturate"><br>
<label>Hue</label><input type="range" min="0" max="360" value="0" class="filter-slider" id="hue"><br>
<label>Blur</label><input type="range" min="0" max="10" value="0" class="filter-slider" id="blur"><br>
<br>

<!-- UPLOAD -->
<h3>Add Media Slides</h3>
<p>Upload images, videos, or .txt file of links.</p>
<input type="file" id="files" multiple accept="image/*,video/*,.txt,text/plain"><br><br>

<!-- ⭐️ NEW: Add this button -->
<button onclick="addStreamSlide()" style="width:98%; padding: 10px; background: #007bff; color: white; border-radius: 5px; cursor: pointer;">
    Add Live Stream Slide
</button>
<br><br>

<!-- ADD EMBEDS (Moved from <style> block) -->
<h3>Add Embeds / Links</h3>
<textarea id="embed-input" placeholder="Paste embed code, URL, YouTube link, etc."
style="width:98%; height:80px;"></textarea><br>
<button onclick="addEmbed()" style="margin-top:5px;">Add Embed</button>
<br><br>

</div>

<script>

/* ============================================================
    PHASE 2 ULTRA JAVASCRIPT ENGINE
============================================================ */

let slides = [];
let current = 0;
let filters = {bright:100, contrast:100, saturate:100, hue:0, blur:0};
let musicList = [];
let trackIndex = 0;
let slideshowInterval = null;
let currentStream = null;
let inactivityTimer = null; // ⭐️ NEW: Add this variable
    
/* ============= FILTER ENGINE ================== */
function applyFilters() {
    let f = `
        brightness(${filters.bright}%)
        contrast(${filters.contrast}%)
        saturate(${filters.saturate}%)
        hue-rotate(${filters.hue}deg)
        blur(${filters.blur}px)
    `;
    document.querySelectorAll('.slide').forEach(s => {
        s.style.filter = f;
    });
}

['bright','contrast','saturate','hue','blur'].forEach(id=>{
    document.getElementById(id).oninput = e=>{
        filters[id] = e.target.value;
        applyFilters();
    };
});

/* ============= DASHBOARD MODE SWITCH ============== */
function setDashboardMode(mode) {
    document.body.dataset.dash = mode;
}

/* ============= CREATE SLIDE ======================= */
function createSlide(type, src, caption="", desc="") {
    const s = document.createElement("div");
    s.className = "slide";

    let el;
    if(type==="img") {
        el = document.createElement("img");
        el.src = src;
    } else if(type==="video") {
        el = document.createElement("video");
        el.src = src; 
        el.autoplay=true; 
        el.loop=true; 
        el.muted=true; // Muted by default so music can play
        el.controls=true;
    }
    
    // Only append if 'el' was created
    if (el) {
        s.appendChild(el);
    } else {
        console.error("Unknown slide type:", type);
        return; // Don't add a broken slide
    }

    document.getElementById("slideshow").appendChild(s);

    slides.push({ type, src, caption, desc, element: s });
    addTimelineThumb(src);

    if(slides.length===1) showSlide(0);
}

/* ============= TIMELINE =========================== */
function addTimelineThumb(src) {
    const t = document.createElement("div");
    t.className = "timeline-item";
    t.draggable = true; // Make item draggable

    // ⭐️ MODIFIED: Handle 'stream' type
    if (src === "stream") {
        t.innerHTML = `<div style="background:#007bff;color:white;font-size:10px;text-align:center;padding-top:20px;">Stream</div>`;
    }
    // For images, show thumbnail
    else if (src.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        t.innerHTML = `<img src="${src}">`;
    } 
    // for video/other, use placeholder
    else {
        t.innerHTML = `<div style="background:#444;color:white;font-size:10px;text-align:center;padding-top:20px;">Media</div>`;
    }
    // ⭐️ END MODIFICATION

    // Main click to show slide
    t.onclick = (e)=>{
        if (e.target.classList.contains('delete-slide-btn')) return; 
        stopSlideshow(); 
        showSlide([...t.parentNode.children].indexOf(t));
    }
    
    // Add delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-slide-btn";
    deleteBtn.innerHTML = "&times;";
    deleteBtn.title = "Delete Slide";
    deleteBtn.onclick = (e) => {
        e.stopPropagation(); 
        const index = [...t.parentNode.children].indexOf(t);
        if (confirm("Are you sure you want to delete this slide?")) {
            deleteSlide(index);
        }
    };
    t.appendChild(deleteBtn);
    
    // Drag-and-drop listeners
    t.addEventListener('dragstart', (e) => {
        const index = [...t.parentNode.children].indexOf(t);
        e.dataTransfer.setData('text/plain', index);
        t.classList.add('dragging');
    });
    t.addEventListener('dragend', () => {
        t.classList.remove('dragging');
    });

    document.getElementById('timeline').appendChild(t);
}

/* ============= SHOW SLIDE ========================= */
function showSlide(i) {
    resetInactivityTimer(); // ⭐️ NEW: Add this line at the top
    
    // CRITICAL: Stop any running stream when changing slides
    stopCurrentStream();

    // Handle empty state
    if (slides.length === 0) {
        document.getElementById('caption-bar').innerText = "";
        document.getElementById('description-panel').style.display = "none";
        document.querySelectorAll('.timeline-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
        current = 0;
        return;
    }

    current = (i + slides.length) % slides.length;
    
    // Check if the new slide is a stream slide
    const isStreamSlide = slides[current].type === "stream";

    // ⭐️ If it's a stream slide, pause the auto-transition
    if (isStreamSlide && slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
        // We don't restart it. The user must click "Start Stream",
        // and then manually navigate away or click "Start Auto-Play" again.
    }
    
    document.querySelectorAll('.slide').forEach((s,idx)=>{
        s.classList.toggle('active', idx===current);
        s.classList.remove(
            'fade-in','slide-left','slide-right','zoom-in','zoom-out',
            'blur-in','wipe','glitch','kenburns','cube','flip'
        );
        if (idx===current) {
            let tr = document.getElementById('transitionSelect').value;
            s.classList.add(tr);
        }
    });

    // Handle video play/pause
    slides.forEach((slide, idx) => {
        if (slide.type === "video" && slide.element) {
            const videoEl = slide.element.querySelector("video");
            if(videoEl) {
                if (idx === current) {
                    videoEl.play().catch(e => console.log("Video autoplay blocked."));
                } else {
                    videoEl.pause();
                }
            }
        }
    });

    /* captions */
    document.getElementById('caption-bar').innerText = slides[current].caption||"";

    /* description */
    const descPanel = document.getElementById('description-panel');
    const descText = slides[current].desc || "";
    descPanel.innerText = descText;
    descPanel.style.display = descText ? "block" : "none";

    /* timeline highlight */
    document.querySelectorAll('.timeline-item').forEach((t,idx)=>{
        t.classList.toggle('active', idx===current);
    });
}

// ...

function stopSlideshow() {
    if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
    }
    // ⭐️ CRITICAL: Also stop any stream when slideshow is stopped
    stopCurrentStream();
}

/* ============= ⭐️ NEW: DELETE SLIDE ====================== */
function deleteSlide(index) {
    if (index < 0 || index >= slides.length) return;

    stopSlideshow();

    // Get elements to remove
    const slideToRemove = slides[index].element;
    const timelineItemToRemove = document.getElementById('timeline').children[index];

    // Remove from array
    slides.splice(index, 1);

    // Remove from DOM
    if(slideToRemove) slideToRemove.remove();
    if(timelineItemToRemove) timelineItemToRemove.remove();

    // Handle empty slideshow
    if (slides.length === 0) {
        current = 0;
        showSlide(current); // Will run the empty-state check
        return;
    }

    // Adjust 'current' index
    if (current > index) {
        // Deleted a slide *before* the current one
        current--; 
    } else if (current === index) {
        // Deleted the *current* slide.
        // Cap index to new max length
        if (current >= slides.length) {
            current = slides.length - 1; 
        }
    }
    // else (current < index), no change needed.

    // Force a refresh.
    // Remove 'active' from all, then let showSlide re-add it.
    document.querySelectorAll('.slide.active').forEach(s => s.classList.remove('active'));
    showSlide(current);
}

/* ============= FILE UPLOAD ======================== */
document.getElementById('files').onchange = e=>{
    [...e.target.files].forEach(file=>{
        let url = URL.createObjectURL(file);
        if (file.type.startsWith('image')) createSlide("img",url,file.name);
        if (file.type.startsWith('video')) createSlide("video",url,file.name);
        
        // ⭐️ FIXED: Text file upload logic
        if (file.type === "text/plain") {
            let r = new FileReader();
            r.onload = ev => {
                ev.target.result.split("\n").forEach(line => {
                    if (line.trim()) {
                        // Use the existing addEmbed logic
                        document.getElementById("embed-input").value = line.trim();
                        addEmbed();
                    }
                });
            };
            r.readAsText(file);
        }
    });
};

// ⭐️ REMOVED: Stray 'if' block that was here
// ⭐️ REMOVED: Duplicate 'musicList' and 'trackIndex' declarations

/* ============================================================
   MUSIC PLAYLIST ENGINE — (⭐️ NEW UPGRADED VERSION ⭐️)
============================================================ */

// Helper: Adds a track to the list and auto-plays if needed
function addTrackToPlaylist(name, url) {
    musicList.push({ name: name, url: url });

    // Auto-play if it's the first track
    if (musicList.length === 1 && document.getElementById("bgm").paused) {
        playCurrentTrack();
    }
}

// Helper: Tries to get a nice name from a URL
function getTrackNameFromUrl(url) {
    try {
        const path = new URL(url).pathname;
        const filename = path.substring(path.lastIndexOf('/') + 1);
        return decodeURIComponent(filename) || url; // Return decoded filename or the full URL
    } catch (e) {
        return url; // If it's not a valid URL, just return the string
    }
}

/* Update track list visually */
function refreshTrackList() {
    const list = document.getElementById("track-list");
    list.innerHTML = "";

    musicList.forEach((track, i) => {
        const div = document.createElement("div");
        div.style.padding = "5px";
        div.style.cursor = "pointer";
        div.style.background = i === trackIndex ? "rgba(255,255,0,0.2)" : "transparent";
        div.style.borderBottom = "1px solid #444";
        
        // Truncate long names for display
        const displayName = track.name.length > 30 ? track.name.substring(0, 30) + "..." : track.name;
        div.innerText = (i+1) + ". " + displayName;
        div.title = track.name; // Show full name on hover
        
        div.onclick = () => {
            trackIndex = i;
            playCurrentTrack();
        };

        list.appendChild(div);
    });
}

/* Load and play the current track */
function playCurrentTrack() {
    const audio = document.getElementById("bgm");
    if (musicList.length === 0) {
        audio.src = ""; // Clear the player
        return;
    }

    audio.src = musicList[trackIndex].url;
    audio.play();
    refreshTrackList();
}

/* Next track */
function nextTrack() {
    if (musicList.length === 0) return;
    trackIndex = (trackIndex + 1) % musicList.length;
    playCurrentTrack();
}

/* Previous track */
function prevTrack() {
    if (musicList.length === 0) return;
    trackIndex = (trackIndex - 1 + musicList.length) % musicList.length;
    playCurrentTrack();
}

/* Auto-next when a track ends */
document.getElementById("bgm").onended = nextTrack;

/* --- ⭐️ NEW: UPLOAD HANDLERS ⭐️ --- */

// 1. Handle "Add Music File(s)" button
document.getElementById("music-upload").onchange = (e) => {
    [...e.target.files].forEach(file => {
        if (file.type.startsWith("audio/")) {
            const url = URL.createObjectURL(file);
            addTrackToPlaylist(file.name, url);
        }
    });
    refreshTrackList(); // Refresh list after adding all files
};

// 2. Handle "Add Music Folder" button
document.getElementById("music-folder-upload").onchange = (e) => {
    const audioFileTypes = ["audio/mpeg", "audio/wav", "audio/ogg", "audio/mp4", "audio/aac"];
    
    [...e.target.files].forEach(file => {
        // Check by file extension or type
        if (file.type.startsWith("audio/") || file.name.match(/\.(mp3|wav|ogg|m4a|aac)$/i)) {
            const url = URL.createObjectURL(file);
            addTrackToPlaylist(file.name, url);
        }
    });
    refreshTrackList(); // Refresh list after adding all files
};

// 3. Handle "Add Links (.txt)" button
document.getElementById("music-links-upload").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
        const text = ev.target.result;
        const urls = text.split('\n').filter(line => line.trim().startsWith('http')); // Get all lines that start with http

        urls.forEach(url => {
            const name = getTrackNameFromUrl(url);
            addTrackToPlaylist(name, url.trim());
        });
        refreshTrackList(); // Refresh list after adding all links
    };
    reader.readAsText(file);
};

/* ============================================================
   EMBEDS + LINK PREVIEW + VIDEO LINK ENGINE
============================================================ */

function addEmbed() {
    const raw = document.getElementById("embed-input").value.trim();
    if (!raw) return;
    
    let handled = false;

    // CASE 1 — Raw embed code (iframe, script, HTML blocks)
    if (raw.startsWith("<")) {
        createEmbedSlide(raw, "Custom Embed");
        handled = true;
    }

    // CASE 2 — YouTube Link
    if (!handled && (raw.includes("youtube.com") || raw.includes("youtu.be"))) {
        const id = extractYouTubeID(raw);
        if (id) {
            createEmbedSlide(
                `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`,
                "YouTube"
            );
            handled = true;
        }
    }

    // CASE 3 — Vimeo Link
    if (!handled && raw.includes("vimeo.com")) {
        const id = raw.split("/").pop().split("?")[0];
        createEmbedSlide(
            `<iframe src="https://player.vimeo.com/video/${id}?autoplay=1&muted=1" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`,
            "Vimeo"
        );
        handled = true;
    }

    // CASE 4 — Video File URL
    if (!handled && raw.match(/\.(mp4|webm|ogg|mov)$/i)) {
        createSlide("video", raw, "Video Link");
        handled = true;
    }
    
    // CASE 5 - Image File URL
    if (!handled && raw.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        createSlide("img", raw, "Image Link");
        handled = true;
    }

    // ⭐️ FIX: CASE 6 — Generic Website URL (Create a link, NOT a broken iframe)
    if (!handled) {
        // Create a nice-looking link slide instead of a failed iframe
        const cleanUrl = new URL(raw).hostname; // Get 'aviationweather.gov'
        const linkHTML = `
            <div style="width:100%; height:100%; background:#222; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; padding:20px; box-sizing: border-box;">
                <h2 style="font-size: 2.5em;">Link</h2>
                <p style="font-size: 1.5em;">This site's security policy prevents embedding.</p>
                <a href="${raw}" target="_blank" rel="noopener noreferrer" style="font-size: 1.8em; color: #3498db; background: #fff; padding: 15px 25px; border-radius: 8px; text-decoration: none; font-weight: bold;">
                    Click to open: ${cleanUrl}
                </a>
            </div>
        `;
        createEmbedSlide(linkHTML, "Link: " + cleanUrl);
        handled = true;
    }

    document.getElementById("embed-input").value = "";
}
    
/* Extract YouTube Video ID */
function extractYouTubeID(url) {
    let id = null;
    try {
        const urlObj = new URL(url);
        if (urlObj.hostname === "youtu.be") {
            id = urlObj.pathname.substring(1);
        } else if (urlObj.hostname.includes("youtube.com")) {
            id = urlObj.searchParams.get("v");
        }
        if(id) return id.split(/[?&]/)[0];
    } catch (e) {
        console.error("Invalid URL for YouTube", e);
    }
    return id;
}

/* Create a raw embed slide */
function createEmbedSlide(html, caption="Embed") {
    const s = document.createElement("div");
    s.className = "slide";
    s.innerHTML = html;

    // ⭐️ FIX: Force all links to open in a new tab
    s.querySelectorAll('a').forEach(a => {
        a.target = "_blank";
        a.rel = "noopener noreferrer"; // Good practice for security
    });

    document.getElementById("slideshow").appendChild(s);

    // ⭐️ FIX: Find and "re-activate" <script> tags
    s.querySelectorAll('script').forEach(oldScript => {
        const newScript = document.createElement("script");

        // Copy all attributes (src, async, defer, etc.)
        Array.from(oldScript.attributes).forEach(attr => {
            newScript.setAttribute(attr.name, attr.value);
        });

        // Copy inline script content
        if (oldScript.textContent) {
            newScript.textContent = oldScript.textContent;
        }

        // Replace the old, "dead" script with the new, "live" one
        oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    
    slides.push({ type:"embed", html, caption, desc:"", element: s });

    addTimelineThumbFromHTML(html);
    if (slides.length===1) showSlide(0);
}

// ⭐️ REMOVED: Redundant 'createLinkPreviewSlide' function (merged into addEmbed)

/* Thumbnail for non-image items */
function addTimelineThumbFromHTML(html) {
    const t = document.createElement("div");
    t.className = "timeline-item";
    t.draggable = true; // ⭐️ Make item draggable
    
    let label = "Embed";
    if (html.includes("youtube.com")) label = "YouTube";
    else if (html.includes("vimeo.com")) label = "Vimeo";
    else if (html.includes("<iframe")) label = "Link";
    
    t.innerHTML = `<div style="background:#444; color:white; font-size:10px; text-align:center; padding-top:20px;">${label}</div>`;
    
    // Main click to show slide
    t.onclick = (e)=>{
        if (e.target.classList.contains('delete-slide-btn')) return; 
        stopSlideshow(); 
        showSlide([...t.parentNode.children].indexOf(t));
    };

    // Add delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-slide-btn";
    deleteBtn.innerHTML = "&times;";
    deleteBtn.title = "Delete Slide";
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        const index = [...t.parentNode.children].indexOf(t);
        if (confirm("Are you sure you want to delete this slide?")) {
            deleteSlide(index);
        }
    };
    t.appendChild(deleteBtn);

    // ⭐️ NEW: Drag-and-drop listeners
    t.addEventListener('dragstart', (e) => {
        // Find index *at the moment drag starts*
        const index = [...t.parentNode.children].indexOf(t);
        e.dataTransfer.setData('text/plain', index);
        t.classList.add('dragging');
    });
    t.addEventListener('dragend', () => {
        t.classList.remove('dragging');
    });

    document.getElementById('timeline').appendChild(t);
}

// ⭐️ REMOVED: Redundant 'media-upload' handler

/* ============================================================
   ⭐️ NEW: AUTO-TRANSITION ENGINE ⭐️
============================================================ */

function startSlideshow() {
    stopSlideshow(); // Clear any existing timer first
    
    let duration = document.getElementById('interval-duration').value * 1000;
    if (duration < 1000) duration = 1000; // Minimum 1 second
    
    if (slides.length > 0) {
        slideshowInterval = setInterval(() => {
            showSlide(current + 1);
        }, duration);
    }
}

function stopSlideshow() {
    if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
    }
}

/* ============================================================
   ⭐️ NEW: LIVE STREAMING FUNCTIONS ⭐️
============================================================ */

function addStreamSlide() {
    stopSlideshow(); // Pause auto-play

    const s = document.createElement("div");
    s.className = "slide";
    s.dataset.type = "stream"; // Add data-type for identification

    // Create the placeholder with video element (initially hidden) and button
    s.innerHTML = `
        <div class="stream-placeholder">
            <video class="stream-video" muted playsinline></video>
            <button class="stream-start-btn">Click to Start Stream</button>
        </div>
    `;

    // Add click event to the button *inside* this specific slide
    s.querySelector('.stream-start-btn').onclick = () => {
        startStream(s);
    };

    document.getElementById("slideshow").appendChild(s);
    slides.push({ type: "stream", caption: "Live Stream", desc: "", element: s });

    addTimelineThumb("stream"); // Use a special key for the thumbnail
    if (slides.length === 1) showSlide(0);
}

async function startStream(slideElement) {
    stopCurrentStream(); // Stop any other stream first

    try {
        // Prompt user to select a tab
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always", displaySurface: "browser" },
            audio: { suppressLocalAudioPlayback: false },
            preferCurrentTab: true,
            systemAudio: "include"
        });
        
        currentStream = stream; // Store the stream globally
        
        // Find elements inside this slide
        const video = slideElement.querySelector('.stream-video');
        const button = slideElement.querySelector('.stream-start-btn');
        
        // Play the stream
        video.srcObject = stream;
        video.play();
        
        // Update UI
        video.style.display = 'block';
        button.style.display = 'none';

        // Listen for when user clicks the browser's "Stop sharing" button
        stream.getVideoTracks()[0].onended = () => {
            stopCurrentStream();
        };

    } catch (err) {
        console.error("Error starting stream:", err);
        stopCurrentStream(); // Clean up on error
    }
}

function stopCurrentStream() {
    if (!currentStream) return; // No stream to stop

    // Stop all tracks (video and audio)
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;

    // Reset UI for ALL stream slides
    document.querySelectorAll('.slide[data-type="stream"]').forEach(slide => {
        const video = slide.querySelector('.stream-video');
        const button = slide.querySelector('.stream-start-btn');
        
        if (video) {
            video.srcObject = null;
            video.style.display = 'none';
        }
        if (button) {
            button.style.display = 'block';
        }
    });
}

/* ============================================================
   ⭐️ NEW: INACTIVITY TIMER FOR UI
============================================================ */

function hideControls() {
    document.getElementById('timeline').classList.add('hidden');
    document.getElementById('caption-bar').classList.add('hidden');
}

function showControls() {
    document.getElementById('timeline').classList.remove('hidden');
    document.getElementById('caption-bar').classList.remove('hidden');
}

function resetInactivityTimer() {
    showControls(); // Always show controls on activity
    
    // Clear the old timer if it exists
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    // Set a new timer to hide them after 5 seconds
    inactivityTimer = setTimeout(hideControls, 5000); // 5000ms = 5 seconds
}
    
/* ======= Basic Left/Right Navigation =============== */
document.onkeydown = e=>{
    // Ignore keys if user is typing in an input
    if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") {
        return;
    }
    
    if (e.key==="ArrowRight") {
        stopSlideshow(); // ⭐️ ADDED: Stop auto-play
        showSlide(current+1);
    }
    if (e.key==="ArrowLeft") {
        stopSlideshow(); // ⭐️ ADDED: Stop auto-play
        showSlide(current-1);
    }
};

/* ============================================================
   FEATURE: DRAGGABLE DASHBOARD
============================================================ */

function makeDashboardDraggable() {
    const dashboard = document.getElementById('dashboard');
    const handle = dashboard.querySelector('h2');

    if (!handle) return;

    handle.onmousedown = function(event) {
        // Only allow dragging in floating mode
        if (document.body.dataset.dash !== 'floating') {
            return;
        }

        event.preventDefault();
        
        let shiftX = event.clientX - dashboard.getBoundingClientRect().left;
        let shiftY = event.clientY - dashboard.getBoundingClientRect().top;

        function moveAt(pageX, pageY) {
            dashboard.style.left = pageX - shiftX + 'px';
            dashboard.style.top = pageY - shiftY + 'px';
        }

        function onMouseMove(event) {
            moveAt(event.pageX, event.pageY);
        }

        // Move the dashboard on mousemove
        document.addEventListener('mousemove', onMouseMove);

        // Drop the dashboard, remove listeners
        document.onmouseup = function() {
            document.removeEventListener('mousemove', onMouseMove);
            document.onmouseup = null;
        };
    };

    handle.ondragstart = function() {
        return false; // Disable native browser drag
    };
}

// Run the function
makeDashboardDraggable();

/* ============================================================
   FEATURE: REARRANGEABLE TIMELINE
============================================================ */

// This function reorders BOTH the JavaScript array and the DOM
function reorderSlides(oldIndex, newIndex) {
    const timeline = document.getElementById('timeline');
    
    // 1. Adjust array
    // Remove the slide from its old position
    const [movedSlide] = slides.splice(oldIndex, 1);
    // Insert it into the new position
    slides.splice(newIndex, 0, movedSlide);

    // 2. Adjust DOM
    // Get the DOM element to move
    const itemToMove = timeline.children[oldIndex];
    // Remove it
    itemToMove.remove();
    // Insert it in the new DOM position
    timeline.insertBefore(itemToMove, timeline.children[newIndex]);

    // 3. Update 'current' index to follow the slide
    if (current === oldIndex) {
        current = newIndex;
    } else if (current > oldIndex && current <= newIndex) {
        // Moved an item from before current to after, shift current left
        current--;
    } else if (current < oldIndex && current >= newIndex) {
        // Moved an item from after current to before, shift current right
        current++;
    }
    
    // 4. Re-highlight the correct timeline item
    showSlide(current);
}

// This function adds the drop listeners to the timeline
function initTimelineSorting() {
    const timeline = document.getElementById('timeline');

    // Add 'dragover' to allow dropping
    timeline.addEventListener('dragover', (e) => {
        e.preventDefault(); // Necessary to allow 'drop'
        
        // Find the item we're dragging over
        const afterElement = getDragAfterElement(timeline, e.clientX);
        const dragging = document.querySelector('.dragging');
        
        if (afterElement == null) {
            timeline.appendChild(dragging);
        } else {
            timeline.insertBefore(dragging, afterElement);
        }
    });
    
    // Add 'drop' to finalize the reorder
    timeline.addEventListener('drop', (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector('.dragging');
        if (!draggingItem) return;
        
        const oldIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const newIndex = [...timeline.children].indexOf(draggingItem);
        
        // Call the reorder function
        reorderSlides(oldIndex, newIndex);
    });
}

// Helper function to find where to drop the item
function getDragAfterElement(container, x) {
    const draggableElements = [...container.querySelectorAll('.timeline-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Run the function
initTimelineSorting();

/* ============================================================
   ⭐️ NEW: Fullscreen and Panel Toggle Logic
============================================================ */

const dashboard = document.getElementById('dashboard');
const showPanelBtn = document.getElementById('show-panel-btn');
const closePanelBtn = document.getElementById('close-panel-btn');
const fullscreenBtn = document.getElementById('fullscreen-btn');

// --- Toggle Panel Logic ---
showPanelBtn.onclick = () => {
    dashboard.style.display = 'block';
};
closePanelBtn.onclick = () => {
    dashboard.style.display = 'none';
};

// --- Toggle Fullscreen Logic ---
fullscreenBtn.onclick = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
};

/* ============================================================
   ⭐️ NEW: Start the inactivity listener
============================================================ */
document.onmousemove = resetInactivityTimer; // Reset on mouse move
resetInactivityTimer(); // Start the timer on page load
 
</script>
</body>
</html>
